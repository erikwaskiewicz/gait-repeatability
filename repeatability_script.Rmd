---
title: "Repeatability script"
author: "Erik Waskiewicz"
date: "24/05/2018"
output: pdf_document
header-includes: 
  - \usepackage{rotating}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
## INSTRUCTIONS:
# Create directory for study
# copy repeatability script and settings script into new study directory
# copy raw data into new directory named 'raw_data' within the study directory
# open settings file and follow instructions
# edit title, author and date above
# once setting have been checked, save file and click knit

# Dont edit from here onwards!
######################################################################
source('repeatability_settings.R')
```

# Summary  
```{r summary, results='asis'}
cat('  \n## Parameters - ', settings_summary_count(study_parameters), '  \n')
settings_summary_list(study_parameters)

cat('  \n## Assessors - ', settings_summary_count(study_assessors), '  \n')
settings_summary_list(study_assessors)

cat('  \n## Number of sessions - ', settings_summary_count(study_sessions), '  \n')
```


```{r data sorting, results='hide'}
input_list <- vector('list', length(study_sides))
i=1
for (data in study_sides) {
  # load headers and data seperately
  temp_headers <- load_headers(data[2])
  temp_data <- load_data(data[2])
  temp_data$mean <- rowMeans(temp_data)
  # combine and sort data
  temp_sorted <- sort_data(temp_data, temp_headers)
  input_list[[i]] <- temp_sorted
  i=i+1
}
# concatenate dataframes in list
sorted_data <- do.call('rbind', input_list)
write.csv(sorted_data, 'results/all_data_sorted.csv')
# clean up
rm(temp_headers, temp_data, temp_sorted, data, input_list, i)
```


```{r main analysis, results='asis', fig.width=9, fig.height=12}
# create empty gait reliability profile df
grp_df <- create_grp_df()
for (parameter in study_parameters){
### Data from all trials
  # format pdf
  cat('\n\\pagebreak\n')
  cat('  \n##', parameter[1], '  \n###All trials', '  \n')
  # subset by side
  temp_side_list <- vector('list', length(study_sides))
  i=1
  for (side in study_sides){
    # subset total data by joint and axis
    temp_parameter <- paste(side[1], parameter[2], sep = ' ')
    temp_df <- split_by_joint(sorted_data, temp_parameter, parameter[3])
    temp_output <- dcast(temp_df, Session.assessor+Session.number+unique_id~variable, value.var = 'value')
    write.csv(temp_output, paste('results/', side[1], '_', parameter[1], '_df_all.csv', sep = ''))
    # Loop through sessions
    temp_session_list <- vector('list', length(study_sessions))
    j=1
    for (study in study_sessions) {
      # plot graph
      temp_plot <- plot_graph_all(temp_df, parameter[1]) + theme(legend.position = 'none')
      temp_leg <- get_legend(plot_graph_all(temp_df, parameter[1]))
      temp_session_list[[j]] <- temp_plot
      j=j+1
    }
    temp_side_list[[i]] <- temp_session_list
    i=i+1
  }
  # combine left and right plots, display plot and save
  temp_plot <- combine_plots(temp_side_list, temp_leg)
  plot(temp_plot)
  temp_name <- paste('results/', parameter[1], '_plot_all.png', sep = '')
  save_plot(temp_name, temp_plot, base_height = 15, base_width = 12)
  # clean up
  rm(temp_df, temp_plot, temp_session_list, temp_side_list, temp_parameter, temp_leg, temp_name, side, i, study, j)

### Aggregated data for plots
  # format pdf
  cat('\n\\pagebreak\n')
  cat('  \n##', parameter[1], '  \n###Aggregated', '  \n')
  # create empty lists
  temp_mean_list <- vector('list', length(study_sides))
  temp_sem_list <- vector('list', length(study_sides))
  temp_kin_list <- vector('list', length(study_sides))
  # subset by side
  i=1
  for (side in study_sides){
    # subset total data by joint and axis and calculate aggregate data
    temp_parameter <- paste(side[1], parameter[2], sep = ' ')
    temp_df <- split_by_joint(sorted_data, temp_parameter, parameter[3])
    temp_output <- agg_combine()
    # plot means, sem and kinematics and add to list to be combined later
    temp_mean_list[[i]] <- plot_graph_means(temp_output, parameter[1]) + theme(legend.position = 'none')
    leg_means <- get_legend(plot_graph_means(temp_output, parameter[1]))
    temp_sem_list[[i]] <- plot_graph_sem(temp_output) + theme(legend.position = 'none')
    leg_sem <- get_legend(plot_graph_sem(temp_output))
    temp_kin_list[[i]] <- plot_kinematics(temp_df) + theme(legend.position = 'none')
    leg_kin <- get_legend(plot_kinematics(temp_df))
    
### Aggregated data for gait reproducibility profile
    temp_grp <- grp_df_loop(temp_output)
    # loop through assessors for assessor WASS
    temp_wass_list <- vector('list', length(study_assessors))
    temp_wass_names <- vector('list', length(study_assessors))
    temp_intertrial_list <- vector('list', length(study_assessors))
    temp_intertrial_names <- vector('list', length(study_assessors))
    j=1
    for (a in study_assessors){
      temp_wass_list[[j]] <- subset(temp_output, assessor == a[1] & no == 'All' & variable == 'mean' & measurement == 'Within assessor SD')$value
      temp_intertrial_list[[j]] <- subset(temp_output, assessor == a[1] & no == 'All' & variable == 'mean' & measurement == 'Inter-trial RMS')$value
      temp_wass_names[[j]] <- paste('WASS', a[1], sep = '-')
      temp_intertrial_names[[j]] <- paste('Intertrial', a[1], sep = '-')
      j=j+1
    }
    temp_grp <- combine_grp(temp_grp)
    # calcualtions and add to list
    grp_df <- combine_grp2(temp_grp, grp_df)
  
### Save dataframe
    # unmelt and save df
    temp_output <- dcast(temp_output, assessor+no+measurement~variable, value.var = 'value')
    write.csv(temp_output, paste('results/', side[1], '_', parameter[1], '_df_processed.csv', sep = ''))
    i=i+1
  }
### Combine left and right aggregate plots, display and save
  temp_plot <- combine_plots3()
  plot(temp_plot)
  temp_name <- paste('results/', parameter[1], '_plot_aggregated.png', sep = '')
  save_plot(temp_name, temp_plot, base_height = 15, base_width = 12)
  # clean up
  rm(temp_df, temp_parameter, side, temp_output, temp_wass_list, temp_wass_names, temp_intertrial_list, temp_intertrial_names, temp_grp, a, j, parameter, temp_plot, temp_name, i)
}
```

\newpage
## Gait reliability profile - all
  
```{r plot GRP, results='asis', fig.width=9, fig.height=4}
# Plot graph and table for gait reliability profile of all assessors
grp_long <- melt(grp_df, id.vars = 'Parameter')
plot(plot_all_grp(grp_df))
print(xtable(grp_df[c(1,2,3,4,11,12,13)]), type = 'latex', include.rownames = FALSE, comment = FALSE)
# Plot graph and table for gait reliability profile of each assessor
for (assessor in study_assessors) {
  # format pdf
  cat('\n\\pagebreak\n')
  cat('  \n## Gait reliability profile -- ', assessor[1], '  \n')
  # make per assessor dataframe, plot graph and print table
  assessor_df <- create_grp_assessor_df(assessor)
  plot(plot_assessor_grp(assessor_df))
  print(xtable(assessor_df), type = 'latex', include.rownames = FALSE, comment = FALSE)
}
# cleanup
rm(assessor, assessor_df, grp_df, grp_long)
```
